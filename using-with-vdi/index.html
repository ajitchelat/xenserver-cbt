<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
  <!--<![endif]-->

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">   
    <title>Using CBT with a VDI - Citrix XenServer Changed Block Tracking Guide</title>
     
    <link rel="shortcut icon" href="
https://www.citrix.com/etc/designs/citrix/icon-favicon.png"> 
    <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="../css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
    <link rel="stylesheet" href="../css/highlight.css">
    <link rel="stylesheet" href="../css/override.css" type="text/css" />
    <link rel="stylesheet" href="../css/font-awesome.css" type="text/css" /> 
    <script>
      // Current page data
      var mkdocs_page_name = "Using CBT with a VDI";
      var mkdocs_page_input_path = "using-with-vdi.md";
      var mkdocs_page_url = "/using-with-vdi/";

    </script>
    
    <script src="../js/jquery-2.1.1.min.js"></script>
    <script src="../js/modernizr-2.8.3.min.js"></script>
    <script type="text/javascript" src="../js/highlight.pack.js"></script>
    <script src="../js/theme.js"></script>
    <script src="../js/custom.js"></script>  
  </head>

  <body class="wy-body-for-nav" role="document">

    <div class="header-top">

        <div class="header-top-left">
          <a href="http://developer-docs.citrix.com" class="logo-position"><img height="60" src="../img/citrixlogoblack.png" target="_blank" class="logo-citrix"><span style="color:#000;font-size: 20px;position: relative;top:4px;left:20px;">Developer Documentation</span></a>
        </div>
        <div class="header-top-right">
          <ul>

            <form id="rtd-search-form-alt" class="wy-form" action="../search.html" method="get">
             <ul class="header-elements">
              <li class="list-inline support">
                <input name="q" id="txtName" type="text" placeholder="Search SDKs" class="searchdocs">
                <a class="fa fa-search errspan"></a>
<!---
              </li>
             <li> <a href="javascript:void(0);" style="font-size: 22px;position: relative;left: -10px;top: 3px"><i class="fa fa-globe"></i></a></li>
             </ul>
             --->
            </form>

          </ul>

        </div>

    </div>
    <div class="body">
      <div class="wy-grid-for-nav">

        
        <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
          <div class="wy-side-nav-search">
            <div role="search">
  <form id ="rtd-search-form-alt" class="wy-form" action="../search.html" method="get">
	<i class="fa fa-search"></i>
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
          </div>

          <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
            <ul class="current">
              
              
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="..">Introduction</a>
		
    </li>

			  
              
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../getting-started/">Getting Started</a>
		
    </li>

			  
              
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../enabling-nbd/">Enabling NBD connection</a>
		
    </li>

			  
              
    <li class="toctree-l1 current">
        <a class="toctree-l1-a current" href="./">Using CBT with a VDI</a>
		
            <ul style="margin-left: 0px;padding-left:15px;border-left: 1px solid #b2b2b2;">
            
                <li class="toctree-l3"><a href="#using-changed-block-tracking-with-a-virtual-disk-image" style="padding:0px;position: relative;">&nbsp;Using changed block tracking with a virtual disk image</a></li>
                
                    <li><a class="toctree-l4" href="#incremental-backup-sets" style="padding:0px;position: relative;">Incremental backup sets</a></li>
                
                    <li><a class="toctree-l4" href="#enabling-changed-block-tracking-for-a-vdi" style="padding:0px;position: relative;">Enabling changed block tracking for a VDI</a></li>
                
                    <li><a class="toctree-l4" href="#disabling-changed-block-tracking-for-a-vdi" style="padding:0px;position: relative;">Disabling changed block tracking for a VDI</a></li>
                
                    <li><a class="toctree-l4" href="#checking-whether-changed-block-tracking-is-enabled" style="padding:0px;position: relative;">Checking whether changed block tracking is enabled</a></li>
                
            
            </ul>
        
    </li>

			  
              
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../deleting-snapshot/">Deleting VDI snapshots</a>
		
    </li>

			  
              
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../list-changed-blocks/">Getting the list of changes blocks in a VDI</a>
		
    </li>

			  
              
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../exporting-changed-blocks/">Exporting changed blocks over NBD</a>
		
    </li>

			  
              
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../coalescing-blocks/">Coalescing changed blocks onto a base VDI</a>
		
    </li>

			  
              
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../appendices/">Appendices</a>
		
    </li>

			  
            </ul>
          </div>
          &nbsp;
        </nav>

        <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

           
          <div class="wy-nav-content">
            <div class="rst-content">
              <!-- <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Using CBT with a VDI</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div> -->
              <div role="main">
                <div class="section">
                <div class="file-format">
                 <div class="leftAlign" style="float: left;visibility: hidden;">
                  </div>
                  <div class="rightAlign" style="float: right;">
                      <span>Download full document:</span>
                      <ul class="file-types">
                        <li><a style="border: 1px solid #EE3D24;padding: 5px;font-size: 11px;color: #EE3D24;border-radius: 5px;font-weight: 700">PDF</a></li>
                        <li><a style="border: 1px solid #2A579A;padding: 5px;font-size: 11px;color: #2A579A;border-radius: 5px;font-weight: 700">DOCX</a></li>
                        <li><a style="border: 1px solid #495164;padding: 5px;font-size: 11px;color: #495164;border-radius: 5px;font-weight: 700">EMAIL</a></li>
                        <li><a style="border: 1px solid #495164;padding: 5px;font-size: 11px;color: #495164;border-radius: 5px;font-weight: 700">PRINT</a></li>
                      </ul>
                  </div>
                  </div>
                   <h1 id="using-changed-block-tracking-with-a-virtual-disk-image">Using changed block tracking with a virtual disk image<a class="headerlink" href="#using-changed-block-tracking-with-a-virtual-disk-image" title="Permanent link">&para;</a></h1>
<p>The changed block tracking capability can be enabled and disabled for individual virtual disk images (VDIs).</p>
<h2 id="incremental-backup-sets">Incremental backup sets<a class="headerlink" href="#incremental-backup-sets" title="Permanent link">&para;</a></h2>
<p>When you enable changed block tracking for a VDI you start a new set of incremental backups for that VDI.
The first action you must take when starting a set of incremental backups is to create a baseline snapshot and to backup its full data.</p>
<p>After you disable changed block tracking, or after changed block tracking is disabled by XenServer or a user, no further incremental backups can be added to this set.
If changed block tracking is enabled again, you must take another baseline snapshot and start a new set of incremental backups.</p>
<p>You cannot compare VDI snapshots taken as part of one set of incremental backups with VDI snapshots taken as part of a different set of incremental backups.
If you attempt to list the changed blocks between snapshots that are part of different sets, you get an error with the message <code>Source and target VDI are unrelated</code>.</p>
<p>You can use some or all of the data in previous incremental backup sets to create VDIs that you can use to restore the state of a VDI.
For more information, see <a href="./coalescing-block.md">Coalescing changed blocks onto a base VDI</a>.</p>
<h2 id="enabling-changed-block-tracking-for-a-vdi">Enabling changed block tracking for a VDI<a class="headerlink" href="#enabling-changed-block-tracking-for-a-vdi" title="Permanent link">&para;</a></h2>
<p>By default, changed block tracking is not enabled for a VDI.
You can enable changed block tracking by using the <code>enable_cbt</code> call.</p>
<p>When changed block tracking is enabled for a VDI, additional log files are created on the SR to list the changes since the last backup.
Blocks of 64 kB within the VDI are tracked and changes to these blocks recorded in the log layer.</p>
<p>The associated VM remains in the same state as before changed block tracking was enabled.</p>
<p>To enable changed block tracking, an SR must be attached, be writable, and have enough free space for the log files to be created on it.
The associated VM can be in any state when changed block tracking is enabled or disabled.
It is not required that the VM be offline.</p>
<p>Changed block tracking can only be enabled for a VDI that is one of the following types:</p>
<ul>
<li>
<p>user</p>
</li>
<li>
<p>system</p>
</li>
</ul>
<p>In addition, if the <code>VDI.on_boot</code> field is set to <code>reset</code>, you cannot enable changed block tracking for the VDI.</p>
<h3 id="examples">Examples<a class="headerlink" href="#examples" title="Permanent link">&para;</a></h3>
<p>You can use any of our supported language bindings to enable changed block tracking for a VDI.
The following examples show how to do it in Python and at the xe command line.</p>
<p>Python:</p>
<div class="codehilite"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">xenapi</span><span class="o">.</span><span class="n">VDI</span><span class="o">.</span><span class="n">enable_cbt</span><span class="p">(</span><span class="o">&lt;</span><span class="n">vdi_ref</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>


<p>xe command line:</p>
<div class="codehilite"><pre><span></span><span class="n">xe</span> <span class="n">vdi</span><span class="o">-</span><span class="n">enable</span><span class="o">-</span><span class="n">cbt</span> <span class="n">uuid</span><span class="o">=&lt;</span><span class="n">vdi</span><span class="o">-</span><span class="n">uuid</span><span class="o">&gt;</span>
</pre></div>


<h3 id="errors">Errors<a class="headerlink" href="#errors" title="Permanent link">&para;</a></h3>
<p>You might see the following errors when using this call:</p>
<p><strong>VDI_MISSING</strong>:</p>
<ul>
<li>
<p>The call cannot find the VDI.</p>
<p>Check that the reference or UUID you are using to refer to the VDI is correct. Check that the VDI exists.</p>
</li>
</ul>
<p><strong>VDI_INCOMPATIBLE_TYPE</strong>:</p>
<ul>
<li>
<p>The VDI is of a type that does not support changed block tracking.</p>
<p>Check that the type of the VDI is <code>system</code> or <code>user</code>.
You can use the <code>get_type</code> call to find out the type of a VDI.
If your VDI is an incompatible type, you cannot enable changed block tracking.
For more information, see <a href="./deleting-snapshots.md">Checking the type of a VDI or VDI snapshot</a>.</p>
</li>
</ul>
<p><strong>VDI_ON_BOOT_MODE_INCOMPATIBLE_WITH_OPERATION</strong>:</p>
<ul>
<li>
<p>The value of the <code>on_boot</code> field of the VDI is set to <code>reset</code>.</p>
<p>Check the value of the <code>on_boot</code> field by using the <code>get_on_boot</code> call.
If appropriate, you can use the <code>set_on_boot</code> call to change the value of this field to <code>persist</code>.</p>
</li>
</ul>
<p><strong>SR_NOT_ATTACHED, SR_HAS_NO_PBDS</strong>:</p>
<ul>
<li>
<p>The call cannot find an attached SR.</p>
<p>Check that there is an SR attached to the host and that the SR is writable.
You cannot enable changed block tracking unless the host has access to an SR to which the changed block information can be written.</p>
</li>
</ul>
<p>If you attempt to enable changed block tracking for a VDI that already has changed block tracking enabled, no error is thrown.</p>
<h2 id="disabling-changed-block-tracking-for-a-vdi">Disabling changed block tracking for a VDI<a class="headerlink" href="#disabling-changed-block-tracking-for-a-vdi" title="Permanent link">&para;</a></h2>
<p>You can disable changed block tracking for a VDI by using the <code>disable_cbt</code> call.</p>
<p>When changed block tracking is disabled for a VDI, the active disks are detached and reattached without the log layer.
The associated VM remains in the same state as before changed block tracking was disabled.</p>
<h3 id="examples_1">Examples<a class="headerlink" href="#examples_1" title="Permanent link">&para;</a></h3>
<p>You can use any of our supported language bindings to disable changed block tracking for a VDI.
The following examples show how to do it in Python and at the xe command line.</p>
<p>Python:</p>
<div class="codehilite"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">xenapi</span><span class="o">.</span><span class="n">VDI</span><span class="o">.</span><span class="n">disable_cbt</span><span class="p">(</span><span class="o">&lt;</span><span class="n">vdi_ref</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>


<p>xe command line:</p>
<div class="codehilite"><pre><span></span><span class="n">xe</span> <span class="n">vdi</span><span class="o">-</span><span class="n">disable</span><span class="o">-</span><span class="n">cbt</span> <span class="n">uuid</span><span class="o">=&lt;</span><span class="n">vdi</span><span class="o">-</span><span class="n">uuid</span><span class="o">&gt;</span>
</pre></div>


<h3 id="errors_1">Errors<a class="headerlink" href="#errors_1" title="Permanent link">&para;</a></h3>
<p>You might see the same sorts of errors for this call and you might for the <code>enable_cbt</code> call.</p>
<p>If you attempt to disable changed block tracking for a VDI that already has changed block tracking disabled, no error is thrown.</p>
<h2 id="checking-whether-changed-block-tracking-is-enabled">Checking whether changed block tracking is enabled<a class="headerlink" href="#checking-whether-changed-block-tracking-is-enabled" title="Permanent link">&para;</a></h2>
<p>The value of the boolean <code>cbt_enabled</code> VDI field shows whether changed block tracking is enabled for that VDI.
You can query the value of this field by using the <code>get_cbt_enabled</code> call.</p>
<p>A return value of <code>true</code> indicated that changed block tracking is enabled for this VDI.</p>
<h3 id="examples_2">Examples<a class="headerlink" href="#examples_2" title="Permanent link">&para;</a></h3>
<p>You can use any of our supported languages to check whether a VDI has changed block tracking enabled.
The following examples show how to do it in Python and at the xe command line.</p>
<p>Python:</p>
<div class="codehilite"><pre><span></span><span class="n">is_cbt_enabled</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">xenapi</span><span class="o">.</span><span class="n">VDI</span><span class="o">.</span><span class="n">get_cbt_enabled</span><span class="p">(</span><span class="o">&lt;</span><span class="n">vdi_ref</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>


<p>xe command line:</p>
<div class="codehilite"><pre><span></span><span class="n">xe</span> <span class="n">vdi</span><span class="o">-</span><span class="n">param</span><span class="o">-</span><span class="n">get</span> <span class="n">param</span><span class="o">-</span><span class="n">name</span><span class="o">=</span><span class="n">cbt</span><span class="o">-</span><span class="n">enabled</span> <span class="n">uuid</span><span class="o">=&lt;</span><span class="n">vdi</span><span class="o">-</span><span class="n">uuid</span><span class="o">&gt;</span>
</pre></div> 

                </div>
              </div>

            </div>
          </div>

        </section>

      </div>
    </div>
    <!--<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span class="prev"><a href="../enabling-nbd/"><i class="fa fa-angle-left"></i> Previous</a></span>
      
      
        <span class="next"><a href="../deleting-snapshot/">Next <i class="fa fa-angle-right"></i></a></span>
      
    </span>
	<div class="footer-right">
		<ul class="social-links">
			<li class="list-inline"><a href="https://twitter.com/citrix"><i class="fa fa-twitter"></i>@citrix</a></li>
			<li class="list-inline"><a href="mailto:support@citrix.com"><i class="fa fa-envelope-o"></i>support@citrix.com</a></li>
		</ul>
		<ul class="inner-pages">
			<li class="list-inline"><a href="http://citrix.com/about/legal">Privacy and Terms</li>
		</ul>
	</div>
</div>-->

  </body>

</html>
